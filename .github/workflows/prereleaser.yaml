name: prereleaser

on:
  # trigger on repository_dispatch event from other GitHub repository workflows
  repository_dispatch:
    types: [prereleaser]

  # allow manual triggering of the workflow by a maintainer
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of the release"
        type: choice
        required: true
        options:
          - 'patch'
          - 'minor'
          - 'major'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIMUS_APP_ID }}
          private-key: ${{ secrets.PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: primus-checkout
        uses: actions/checkout@v4
        with:
          repository: signoz/primus
          ref: main
          path: .primus
          token: ${{ steps.token.outputs.token }}
      - name: git-configure
        run: |
          git config --global user.name "primus-bot[bot]"
          git config --global user.email "171087277+primus-bot[bot]@users.noreply.github.com"
      - name: info
        run: |
          $MAKE info
      - name: verify-releaser-team-membership
        run: |
          if [[ "${{ github.event.name }}" == "repository_dispatch" ]]; then
            echo "skipping, event is triggered from other repository workflow"
            exit 0
          fi
          $MAKE github-verify-team-membership \
            GITHUB_ARGS="-t ${{ steps.token.outputs.token }} \
              -r ${{ github.repository_owner }} \
              -n releaser \
              -u ${{ github.actor }}"
  charts:
    uses: signoz/primus.workflows/.github/workflows/releaser.yaml@main
    secrets: inherit
    needs: [verify]
    with:
      PRIMUS_REF: main
      PROJECT_NAME: charts
      RELEASE_TYPE: ${{ (github.event.client_payload && github.event.client_payload.release_type) || inputs.release_type }}
