{{- if .Values.clickhouseInstance.enabled }}
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: {{ include "clickhouse.fullname" . }}
  namespace: {{ include "clickhouse.namespace" . }}
  labels:
    {{- include "clickhouse.labels" . | nindent 4 }}
    {{- if .Values.clickhouseInstance.labels }}
    {{- toYaml .Values.clickhouseInstance.labels | nindent 4 }}
    {{- end }}
  {{- if .Values.clickhouseInstance.annotations }}
  annotations:
    {{- toYaml .Values.clickhouseInstance.annotations | nindent 4 }}
  {{- end }}
spec:
  defaults:
    templates:
      {{- if and (.Values.clickhouseInstance.persistence.enabled) (not .Values.clickhouseInstance.persistence.existingClaim) }}
      dataVolumeClaimTemplate: data-volumeclaim-template
      # logVolumeClaimTemplate: log-volumeclaim-template
      {{- end }}
      serviceTemplate: service-template

  configuration:
    users:
      {{ .Values.clickhouseInstance.user }}/password: {{ .Values.clickhouseInstance.password }}
      {{ .Values.clickhouseInstance.user }}/networks/ip:
        {{- range $.Values.clickhouseInstance.allowedNetworkIps }}
        - {{ . | quote }}
        {{- end }}
      {{ .Values.clickhouseInstance.user }}/profile: default
      {{ .Values.clickhouseInstance.user }}/quota: default

    profiles:
      {{- merge dict .Values.clickhouseInstance.profiles .Values.clickhouseInstance.defaultProfiles | toYaml | nindent 6 }}

    clusters:
      - name: {{ .Values.clickhouseInstance.cluster | quote }}
        templates:
          podTemplate: pod-template
        layout:
          {{- toYaml .Values.clickhouseInstance.layout | nindent 10 }}

    settings:
      {{- merge dict .Values.clickhouseInstance.settings .Values.clickhouseInstance.defaultSettings | toYaml | nindent 6 }}

    files:
      events.proto: |
        syntax = "proto3";
        message Event {
          string uuid = 1;
          string event = 2;
          string properties = 3;
          string timestamp = 4;
          uint64 team_id = 5;
          string distinct_id = 6;
          string created_at = 7;
          string elements_chain = 8;
        }
      {{- if .Values.clickhouseInstance.coldStorage.enabled }}
      config.d/storage.xml: |
        <clickhouse>
          <storage_configuration>
            <disks>
              <!--
                default disk is special, it always exists even if not explicitly configured here,
                but you can't change it's path here (you should use <path> on top level config instead)
              -->
              <default>
                <!--
                  You can reserve some amount of free space on any disk (including default) by adding
                  keep_free_space_bytes tag.
                -->
                <keep_free_space_bytes>{{ .Values.clickhouseInstance.coldStorage.defaultKeepFreeSpaceBytes }}</keep_free_space_bytes>
              </default>
              {{- if eq .Values.clickhouseInstance.coldStorage.type "s3" }}
              <s3>
                <type>s3</type>
                <endpoint>{{ .Values.clickhouseInstance.coldStorage.endpoint }}</endpoint>
                {{- if .Values.clickhouseInstance.coldStorage.role.enabled }}
                <use_environment_credentials>true</use_environment_credentials>
                {{- else }}
                <access_key_id>{{ .Values.clickhouseInstance.coldStorage.accessKey }}</access_key_id>
                <secret_access_key>{{ .Values.clickhouseInstance.coldStorage.secretAccess }}</secret_access_key>
                {{- end }}
              </s3>
              {{- else if eq .Values.clickhouseInstance.coldStorage.type "gcs" }}
              <gcs>
                <support_batch_delete>false</support_batch_delete>
                <type>s3</type>
                <endpoint>{{ .Values.clickhouseInstance.coldStorage.endpoint }}</endpoint>
                <access_key_id>{{ .Values.clickhouseInstance.coldStorage.accessKey }}</access_key_id>
                <secret_access_key>{{ .Values.clickhouseInstance.coldStorage.secretAccess }}</secret_access_key>
              </gcs>
              {{- end }}
            </disks>
            <policies>
              <tiered>
                <volumes>
                  <default>
                    <disk>default</disk>
                  </default>
                  <s3>
                    <disk>{{ .Values.clickhouseInstance.coldStorage.type }}</disk>
                    <perform_ttl_move_on_insert>0</perform_ttl_move_on_insert>
                    <prefer_not_to_merge>1</prefer_not_to_merge>
                  </s3>
                </volumes>
                <move_factor>0</move_factor>
              </tiered>
            </policies>
          </storage_configuration>
        </clickhouse>
      {{- end }}
      {{ include "clickhouse.files" . | indent 6 }}

    zookeeper:
      nodes:
      {{- if .Values.clickhouseInstance.externalZookeeper }}
        {{- toYaml .Values.externalZookeeper.servers | nindent 8 }}
      {{- else }}
        {{- $replicaCount := default 1 (.Values.zookeeper.replicaCount | int) }}
        {{- $svcName := (include "clickhouse.zookeeper.servicename" .) }}
        {{- $headlessSuffix := (include "clickhouse.zookeeper.headlessSvcSuffix" .) }}
        {{- range $replicaIndex := until $replicaCount }}
        - host: {{ printf "%s-%s.%s" $svcName ($replicaIndex | toString) $headlessSuffix }}
          port: {{ include "clickhouse.zookeeper.port" . }}
        {{- end }}
      {{- end }}

  templates:
    podTemplates:
      - name: pod-template
        metadata:
          labels:
            {{- include "clickhouse.labels" . | nindent 12 }}
            {{- if .Values.clickhouseInstance.podLabels }}
            {{- toYaml .Values.clickhouseInstance.podLabels | nindent 12 }}
            {{- end }}
          {{- with .Values.clickhouseInstance.podAnnotations }}
          annotations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        {{- with .Values.clickhouseInstance.podDistribution }}
        podDistribution:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        spec:
          {{- include "clickhouse.imagePullSecrets" . | indent 10 }}
          serviceAccountName: {{ include "clickhouse.serviceAccountName" . }}
          priorityClassName: {{ .Values.clickhouseInstance.priorityClassName | quote }}
          {{- if .Values.clickhouseInstance.affinity }}
          affinity: {{ toYaml .Values.clickhouseInstance.affinity | nindent 12 }}
          {{- end }}
          {{- if .Values.clickhouseInstance.tolerations }}
          tolerations: {{ toYaml .Values.clickhouseInstance.tolerations | nindent 12 }}
          {{- end }}
          {{- if .Values.clickhouseInstance.nodeSelector }}
          nodeSelector: {{ toYaml .Values.clickhouseInstance.nodeSelector | nindent 12 }}
          {{- end }}
          {{- with .Values.clickhouseInstance.topologySpreadConstraints }}
          topologySpreadConstraints: {{ toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.clickhouseInstance.securityContext.enabled }}
          securityContext: {{- omit .Values.clickhouseInstance.securityContext "enabled" | toYaml | nindent 12 }}
          {{- end }}

          volumes:
            - name: shared-binary-volume
              emptyDir: {}
            - name: custom-functions-volume
              configMap:
                name: {{ include "clickhouse.fullname" . }}-custom-functions
            - name: scripts
              configMap:
                name: {{ include "clickhouse.fullname" . }}-scripts
          {{- if and (not .Values.clickhouseInstance.templates.volumeClaimTemplates) (not .Values.clickhouseInstance.persistence.enabled) }}
            - name: data-volume
              emptyDir: {}
          {{- else if .Values.clickhouseInstance.persistence.existingClaim }}
            - name: existing-volumeclaim
              persistentVolumeClaim:
                claimName: {{ .Values.clickhouseInstance.persistence.existingClaim }}
          {{- end }}
          {{- if .Values.clickhouseInstance.logs.system.enabled }}
            - name: logs-system-config
              configMap:
                name: {{ include "clickhouse.fullname" . }}-logs-system-config
          {{- end }}
          {{- if .Values.clickhouseInstance.additionalVolumes }}
            {{- toYaml .Values.clickhouseInstance.additionalVolumes | nindent 12 }}
          {{- end }}

          {{- if .Values.clickhouseInstance.initContainers.enabled }}
          initContainers:
            {{- if .Values.clickhouseInstance.initContainers.udf.enabled }}
            - name: {{ include "clickhouse.fullname" . }}-udf-init
              image: {{ include "clickhouse.initContainers.udf.image" . }}
              imagePullPolicy: {{ .Values.clickhouseInstance.initContainers.udf.image.pullPolicy }}
              command:
                {{- toYaml .Values.clickhouseInstance.initContainers.udf.command | nindent 16 }}
              volumeMounts:
                - name: shared-binary-volume
                  mountPath: /var/lib/clickhouse/user_scripts
            {{- end }}
            {{- if .Values.clickhouseInstance.initContainers.init.enabled }}
            - name: {{ include "clickhouse.fullname" . }}-init
              image: {{ include "clickhouse.initContainers.init.image" . }}
              imagePullPolicy: {{ .Values.clickhouseInstance.initContainers.init.image.pullPolicy }}
              command:
                {{- toYaml .Values.clickhouseInstance.initContainers.init.command | nindent 16 }}
            {{- end }}
          {{- end }}
          containers:
            - name: clickhouse
              # KEEP CLICKHOUSE-SERVER VERSION IN SYNC WITH
              # https://github.com/SigNoz/signoz/blob/main/deploy/docker/clickhouse-setup/docker-compose.yaml#L5
              image: {{ template "clickhouse.image" . }}
              imagePullPolicy: {{ .Values.clickhouseInstance.image.pullPolicy }}
              command:
                - /bin/bash
                - -c
                - /usr/bin/clickhouse-server --config-file=/etc/clickhouse-server/config.xml
              ports:
                - name: http
                  containerPort: 8123
                - name: client
                  containerPort: 9000
                - name: interserver
                  containerPort: 9009

              {{- if .Values.clickhouseInstance.startupProbe.enabled }}
              startupProbe:
                httpGet:
                  port: {{ .Values.clickhouseInstance.startupProbe.port }}
                  path: {{ .Values.clickhouseInstance.startupProbe.path }}
                initialDelaySeconds: {{ .Values.clickhouseInstance.startupProbe.initialDelaySeconds }}
                periodSeconds: {{ .Values.clickhouseInstance.startupProbe.periodSeconds }}
                timeoutSeconds: {{ .Values.clickhouseInstance.startupProbe.timeoutSeconds }}
                successThreshold: {{ .Values.clickhouseInstance.startupProbe.successThreshold }}
                failureThreshold: {{ .Values.clickhouseInstance.startupProbe.failureThreshold }}
              {{- else if .Values.clickhouseInstance.customStartupProbe }}
              startupProbe:
                {{- toYaml .Values.clickhouseInstance.customStartupProbe | nindent 16 }}
              {{- end }}
              {{- if .Values.clickhouseInstance.livenessProbe.enabled }}
              livenessProbe:
                httpGet:
                  port: {{ .Values.clickhouseInstance.livenessProbe.port }}
                  path: {{ .Values.clickhouseInstance.livenessProbe.path }}
                initialDelaySeconds: {{ .Values.clickhouseInstance.livenessProbe.initialDelaySeconds }}
                periodSeconds: {{ .Values.clickhouseInstance.livenessProbe.periodSeconds }}
                timeoutSeconds: {{ .Values.clickhouseInstance.livenessProbe.timeoutSeconds }}
                successThreshold: {{ .Values.clickhouseInstance.livenessProbe.successThreshold }}
                failureThreshold: {{ .Values.clickhouseInstance.livenessProbe.failureThreshold }}
              {{- else if .Values.clickhouseInstance.customLivenessProbe }}
              livenessProbe:
                {{- toYaml .Values.clickhouseInstance.customLivenessProbe | nindent 16 }}
              {{- end }}
              {{- if .Values.clickhouseInstance.readinessProbe.enabled }}
              readinessProbe:
                httpGet:
                  port: {{ .Values.clickhouseInstance.readinessProbe.port }}
                  path: {{ .Values.clickhouseInstance.readinessProbe.path }}
                initialDelaySeconds: {{ .Values.clickhouseInstance.readinessProbe.initialDelaySeconds }}
                periodSeconds: {{ .Values.clickhouseInstance.readinessProbe.periodSeconds }}
                timeoutSeconds: {{ .Values.clickhouseInstance.readinessProbe.timeoutSeconds }}
                successThreshold: {{ .Values.clickhouseInstance.readinessProbe.successThreshold }}
                failureThreshold: {{ .Values.clickhouseInstance.readinessProbe.failureThreshold }}
              {{- else if .Values.clickhouseInstance.customReadinessProbe }}
              readinessProbe:
                {{- toYaml .Values.clickhouseInstance.customReadinessProbe | nindent 16 }}
              {{- end }}

              volumeMounts:
                - name: shared-binary-volume
                  mountPath: /var/lib/clickhouse/user_scripts
                - name: custom-functions-volume
                  mountPath: /etc/clickhouse-server/functions
                - name: scripts
                  mountPath: /scripts
              {{- if and (not .Values.clickhouseInstance.templates.volumeClaimTemplates) (not .Values.clickhouseInstance.persistence.enabled) }}
                - name: data-volume
                  mountPath: /var/lib/clickhouse
              {{- end }}
              {{- if and (.Values.clickhouseInstance.persistence.enabled) (.Values.clickhouseInstance.persistence.existingClaim) }}
                - name: existing-volumeclaim
                  mountPath: /var/lib/clickhouse
              {{- else if .Values.clickhouseInstance.persistence.enabled }}
                - name: data-volumeclaim-template
                  mountPath: /var/lib/clickhouse
              {{- end }}
              {{- if .Values.clickhouseInstance.additionalVolumeMounts }}
                {{- toYaml .Values.clickhouseInstance.additionalVolumeMounts | nindent 16 }}
              {{- end }}
              {{- if .Values.clickhouseInstance.resources }}
              resources: {{ toYaml .Values.clickhouseInstance.resources | nindent 16 }}
              {{- end }}
              {{- if .Values.clickhouseInstance.logs.system.enabled }}
              lifecycle:
                postStart:
                  exec:
                    command: ["/bin/bash", "/scripts/wait-until-ready.sh"]
              {{- end }}
            {{- if .Values.clickhouseInstance.logs.system.enabled }}
            - name: logs-system-exporter
              image: {{ include "logs.system.image" . }}
              imagePullPolicy: {{ .Values.clickhouseInstance.logs.system.image.pullPolicy }}
              command:
                - /signoz-collector
              args:
                - --config=/conf/config.yaml
              env:
                - name: K8S_NODE_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: spec.nodeName
                - name: K8S_POD_IP
                  valueFrom:
                    fieldRef:
                      apiVersion: v1
                      fieldPath: status.podIP
                - name: K8S_HOST_IP
                  valueFrom:
                    fieldRef:
                      fieldPath: status.hostIP
                - name: K8S_POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
                - name: K8S_POD_UID
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.uid
                - name: K8S_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                - name: OTEL_RESOURCE_ATTRIBUTES
                  value: "k8s.pod.uid=$(K8S_POD_UID),k8s.pod.ip=$(K8S_POD_IP)"
              {{- if .Values.clickhouseInstance.logs.system.resources }}
              resources: {{ toYaml .Values.clickhouseInstance.logs.system.resources | nindent 16 }}
              {{- end }}
              volumeMounts:
                - name: logs-system-config
                  mountPath: /conf
            {{- end }}

            {{- if .Values.clickhouseInstance.extraContainers }}
              {{- toYaml .Values.clickhouseInstance.extraContainers | nindent 14 }}
            {{- end }}

    serviceTemplates:
      - name: service-template
        generateName: {{ include "clickhouse.fullname" . }}
        {{- with .Values.clickhouseInstance.service }}
        metadata:
          labels:
            {{- include "clickhouse.labels" $ | nindent 12 }}
          {{- with .annotations }}
          annotations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        spec:
          type: {{ .type }}
          ports:
            - name: http
              port: {{ .httpPort }}
              {{ include "service.ifClusterIP" .type }}
            - name: tcp
              port: {{ .tcpPort }}
              {{ include "service.ifClusterIP" .type -}}
        {{- end }}

    {{- if and (.Values.clickhouseInstance.persistence.enabled) (not .Values.clickhouseInstance.persistence.existingClaim) }}
    volumeClaimTemplates:
      - name: data-volumeclaim-template
        reclaimPolicy: Retain
        spec:
          accessModes:
            {{- toYaml .Values.clickhouseInstance.persistence.accessModes | nindent 12 }}
          resources:
            requests:
              storage: {{ .Values.clickhouseInstance.persistence.size }}
        {{- $storageClass := default .Values.clickhouseInstance.persistence.storageClass .Values.global.storageClass -}}
        {{- if $storageClass -}}
        {{- if (eq "-" $storageClass) }}
          storageClassName: ""
        {{- else }}
          storageClassName: {{ $storageClass }}
        {{- end }}
    {{- end }}
    {{- end }}

  {{- if and (.Values.clickhouseInstance.templates.volumeClaimTemplates) (not .Values.clickhouseInstance.persistence.enabled) }}
    volumeClaimTemplates:
    {{- range .Values.clickhouseInstance.clickhouseInstance.templates.volumeClaimTemplates }}
      - name: {{ .name }}
        reclaimPolicy: Retain
        spec:
          accessModes:
            {{- toYaml .accessModes | nindent 12 }}
          resources:
            requests:
              storage: {{ .resources.requests.storage }}
          storageClassName: {{ .storageClassName }}
    {{- end }}
  {{- end }}
{{- end }}
