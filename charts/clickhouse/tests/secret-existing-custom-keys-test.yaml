suite: Existing secret with custom keys
tests:
  - it: should not render a Secret
    set:
      clickhouseOperator:
        secret:
          create: false
          name: my-ch-creds
          usernameKey: customuser
          passwordKey: custompass
          password: custompass
    template: templates/clickhouse-operator/secret.yaml
    asserts:
      - notExists: {}
  - it: should reference the custom keys in ClickHouseInstallation
    set:
      user: testuser
      clickhouseOperator:
        secret:
          create: false
          name: my-ch-creds
          usernameKey: customuser
          passwordKey: custompass
          password: custompass
    template: templates/clickhouse-instance/clickhouse-instance.yaml
    asserts:
      - equal:
          path: spec.configuration.users.testuser.password
          value: ${CLICKHOUSE_PASSWORD}
      - equal:
          path: spec.configuration.users.testuser.networks.ip[0]
          value: "10.0.0.0/8"
  - it: should reference the custom keys in clickhouse_operator user config
    set:
      user: testuser
      clickhouseOperator:
        secret:
          create: false
          name: my-ch-creds
          usernameKey: customuser
          passwordKey: custompass
          password: custompass
    template: templates/clickhouse-operator/configmaps/etc-usersd-files.yaml
    asserts:
      - exists:
          path: data['01-clickhouse-user.xml']
      - matchRegex:
          path: data['01-clickhouse-user.xml']
          pattern: '<testuser>'
      - matchRegex:
          path: data['01-clickhouse-user.xml']
          pattern: '<password>\${CLICKHOUSE_PASSWORD}</password>'
